<!DOCTYPE html>
<html>
<head>
  <title>Forums and Composition Charts</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-3d.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
  <style>
    .chart-container {
      margin-bottom: 20px; /* Réduire l'espacement entre les graphiques */
      display: flex;
      justify-content: center;
      background-color: #152342; /* Couleur de fond pour les conteneurs de graphiques */
      align-items: center;
      border-radius: 15px; /* Arrondir les coins des conteneurs */
      padding: 10px; /* Ajouter du padding si nécessaire */
    }
    
    .chart-container.x {
      width: 50%;
      
      margin: 0; /* Supprimer la marge pour aligner les graphiques côte à côte */
    }
    
    .page-title {
      text-align: center; /* Centrer le titre */
      color: #0c1427; /* Couleur du texte du titre */
      margin-top: 20px; /* Espacement au-dessus du titre */
      margin-bottom: 40px; /* Espacement en dessous du titre */
    }
    
    .charts-row {
      display: flex;
      
      justify-content: space-between; /* Espacement entre les graphiques */
      gap: 20px; /* Espacement entre les graphiques */
    }
    
    #chart {
      width: 50%; /* Ajuster la largeur pour s'adapter à l'espace disponible */
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">Dashboards</h1>
  </div>

  <!-- Conteneur pour le graphique des forums -->
  <div id="forums-container" class="chart-container"></div>

  <!-- Conteneur pour le graphique des titres et dates de publication -->
  <div id="titles-dates-container" class="chart-container"></div>

  <!-- Conteneur pour les graphiques côte à côte -->
  <div class="charts-row">
    <!-- Conteneur pour le graphique de la distribution des statuts -->
    <div id="composition-container" class="chart-container x"></div>

    <!-- Conteneur pour le graphique de produits par mois -->
    <div id="chart" class="chart-container x"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Prépare les données des forums depuis Rails
      var forumsData = <%= raw @forums.to_json(only: [:title, :status, :visits, :pub]) %>;
      var statusData = <%= raw @status_data.to_json %>;

      // Trier les forums par nombre de visites en ordre décroissant
      forumsData.sort(function(a, b) {
        return b.visits - a.visits;
      });

      // Sélectionner les 10 forums les plus visités
      var top10Forums = forumsData.slice(0, 8);

      // Transformer les données des forums au format attendu par ApexCharts
      var forumsChartData = top10Forums.map(function(item) {
        return {
          x: item.title,
          y: item.visits // Utilisation du nombre de visites pour le graphique
        };
      });

      // Création du graphique ApexCharts pour les forums (nombre de visites)
      var forumsOptions = {
        series: [{
          name: 'Number of Visits',
          data: forumsChartData
        }],
        chart: {
          type: 'bar',
          height: 300 // Ajuster la hauteur
        },
        xaxis: {
          type: 'category',
          labels: {
            formatter: function(val) {
              return val; // Utiliser le titre du forum comme étiquette
            },
            style: {
              colors: 'white'
            }
          }
        },
        yaxis: {
          labels: {
            formatter: function(val) {
              return val; // Utiliser le titre du forum comme étiquette
            },
            style: {
              colors: 'white'
            }
          }
        },
        title: {
          text: 'Top 10 Most Visited Forums',
          align: 'center', // Aligner le titre au centre
          style: {
            color: 'white', // Couleur du texte du titre
            fontSize: '16px', // Taille de la police du titre (optionnel)
            fontWeight: 'bold' // Poids de la police du titre (optionnel)
          }
        },
        tooltip: {
          x: {
            formatter: function(val) {
              return val; // Afficher le titre du forum
            }
          }
        },
        colors: ['white'] // Couleurs personnalisées pour les séries
      };

      var forumsChart = new ApexCharts(document.querySelector("#forums-container"), forumsOptions);
      forumsChart.render();

      // Création du graphique ApexCharts pour la distribution des statuts
      var compositionOptions = {
        series: statusData.map(function(item) { return item.y; }), // Utiliser les valeurs des statuts
        chart: {
          type: 'pie',
          height: 400, // Ajuster la hauteur
          width: 400 // Ajuster la largeur
        },
         title: {
          text: 'published',
          align: 'center', // Aligner le titre au centre
          style: {
            color: 'white', // Couleur du texte du titre
            fontSize: '16px', // Taille de la police du titre (optionnel)
            fontWeight: 'bold' // Poids de la police du titre (optionnel)
          }
        },
        labels: statusData.map(function(item) { return item.name; }), // Utiliser les noms des statuts
        legend: {
          position: 'bottom', // Position de la légende
          labels: {
            colors: ['white'] // Couleur du texte de la légende
          }
        }
      };

      var compositionChart = new ApexCharts(document.querySelector("#composition-container"), compositionOptions);
      compositionChart.render();

      // Créer une variable pour les données de titre et date
      var titlesDatesRawData = forumsData.map(function(item) {
        return {
          title: item.title,
          pub: item.pub
        };
      });

      // Trier les données par date de publication en ordre décroissant
      titlesDatesRawData.sort(function(a, b) {
        return new Date(b.pub) - new Date(a.pub);
      });

      // Sélectionner les 10 forums les plus récents
      var top10RecentForums = titlesDatesRawData.slice(0, 8);

      // Transformer les données pour le graphique des titres et dates de publication
      var titlesDatesData = top10RecentForums.map(function(item) {
        return {
          x: item.title,
          y: new Date(item.pub).getTime() // Utilisation du timestamp pour le graphique
        };
      });

      // Création du graphique ApexCharts pour les titres et dates de publication
    var titlesDatesOptions = {
    series: [{
        name: 'Publication Date',
        data: titlesDatesData
    }],
    chart: {
        height: 300, // Ajuster la hauteur
        type: 'line',
        zoom: {
            enabled: false
        },
    },
    dataLabels: {
        enabled: true,
        formatter: function(val, opts) {
            // Afficher la date formatée au-dessus de chaque point
            return Highcharts.dateFormat('%Y-%m-%d', new Date(val));
        },
        style: {
            color: 'white' // Couleur du texte des étiquettes de données
        },
        background: {
            enabled: true,
            foreColor: 'white',
            borderRadius: 2,
            borderWidth: 1,
            borderColor: 'white'
        }
    },
    stroke: {
        curve: 'smooth',
        colors: ['#ffffff'] // Couleur des lignes
    },
    title: {
        text: 'Top 10 Most Recent Forums by Publication Date',
        align: 'center', // Aligner le titre au centre
        style: {
            color: 'white', // Couleur du texte du titre
            fontSize: '16px', // Taille de la police du titre
            fontWeight: 'bold' // Poids de la police du titre
        }
    },
    xaxis: {
        type: 'category',
        labels: {
            formatter: function(value) {
                return value; // Utiliser le titre du forum comme étiquette
            },
            style: {
                colors: 'white'
            }
        },
        categories: top10RecentForums.map(function(item) { return item.title; })
    },
    yaxis: {
        labels: {
            formatter: function(val) {
                return Highcharts.dateFormat('%Y-%m-%d', new Date(val)); // Formater les dates sur l'axe des ordonnées
            },
            style: {
                colors: 'white'
            }
        }
    }
};


      var titlesDatesChart = new ApexCharts(document.querySelector("#titles-dates-container"), titlesDatesOptions);
      titlesDatesChart.render();
      var options = {
    series: [{
      name: 'Desktops',
      data: <%= raw @monthly_data[:values].to_json %>
    }],
    chart: {
      height: 350,
      type: 'line',
      zoom: {
        enabled: false
      }
    },
    dataLabels: {
      enabled: false
    },
    stroke: {
      curve: 'smooth'
    },
    title: {
      text: 'Product Trends by Month',
      align: 'center',
      style:{
        color: 'white',
        fontSize: '16px',
        fontWeight: 'bold'
      }
    },
    grid: {
      row: {
        colors: ['#f3f3f3', 'transparent'], // prend un tableau qui sera répété sur les colonnes
        opacity: 0.5
      },
    },
    xaxis: {
      categories: <%= raw @monthly_data[:months].to_json %>,
      labels: {
        style: {
          colors: 'white'
        }
      }
    }, // <- Ajout d'une virgule ici
    yaxis: {
      labels: {
        style: {
          colors: 'white'
        }
      }
    }
  };


  var chart = new ApexCharts(document.querySelector("#chart"), options);
  chart.render();
    });
  </script>
</body>
</html>
